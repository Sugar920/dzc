import unittest
import requests
from types import SimpleNamespace

from sglang.srt.utils import kill_process_tree
from sglang.test.run_eval import run_eval
from sglang.test.test_utils import (
    DEFAULT_SMALL_MODEL_NAME_FOR_TEST,
    DEFAULT_TIMEOUT_FOR_SERVER_LAUNCH,
    DEFAULT_URL_FOR_TEST,
    CustomTestCase,
    popen_launch_server,
)


class TestEnableMultimodal(CustomTestCase):
    #model = DEFAULT_SMALL_MODEL_NAME_FOR_TEST
    model = "/data/Llama-3.2-1B-Instruct/"
    base_url = DEFAULT_URL_FOR_TEST

    @classmethod
    def setUpClass(cls):
        other_args = (
                [
                    "--trust-remote-code",
        #            "--cuda-graph-max-bs",
       #             "16",
                    "--enable-multimodal",
                    "--mem-fraction-static",
                    "0.8",
                    "--attention-backend",
                    "ascend",
                    "--disable-cuda-graph",
                ]
             )
        cls.process = popen_launch_server(
                cls.model,
                cls.base_url,
                timeout=DEFAULT_TIMEOUT_FOR_SERVER_LAUNCH,
                other_args=other_args,
                )


    @classmethod
    def tearDownClass(cls):
        kill_process_tree(cls.process.pid)



    def test_enable_multimodal_func(self):
        response = requests.get(f"{DEFAULT_URL_FOR_TEST}/health_generate")
        self.assertEqual(response.status_code, 200)

        response = requests.post(
                f"{DEFAULT_URL_FOR_TEST}/generate",
                json={
                    "text": "The capital of France is",
                    "sampling_params": {
                    "temperature": 0,
                    "max_new_tokens": 32,
                    },
                    },    
                )   
            
        self.assertEqual(response.status_code, 200)
        self.assertIn("Paris",response.text)

    def test_mmlu(self):
        args = SimpleNamespace(
                    base_url=self.base_url,
                    model=self.model,
                    eval_name="mmlu",
                    num_examples=64,
                    num_threads=32,
                    )

        metrics = run_eval(args)
        self.assertGreaterEqual(metrics["score"], 0.4)


if __name__ == "__main__":
    unittest.main()
